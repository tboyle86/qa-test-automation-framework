#!/bin/bash
#
# Smart Test Execution Pre-Commit Hook
# Analyzes changed files and determines appropriate test execution strategy
#
# Usage: Place in .git/hooks/pre-commit and make executable
# chmod +x .git/hooks/pre-commit

echo "ğŸ” Analyzing changes for smart test execution..."

# Configuration
SMOKE_TESTS="@smoke"
CRUD_TESTS="@crud"
FILTERING_TESTS="@filtering"
SORTING_TESTS="@sorting" 
RESPONSIVE_TESTS="@responsive"
PWA_TESTS="@pwa"
PERFORMANCE_TESTS="@performance"
ACCESSIBILITY_TESTS="@accessibility"

# File pattern to test tag mapping
declare -A FILE_TAG_MAP
FILE_TAG_MAP["song-library"]="@crud"
FILE_TAG_MAP["add-song"]="@crud"
FILE_TAG_MAP["edit-song"]="@crud"
FILE_TAG_MAP["delete-song"]="@crud"
FILE_TAG_MAP["filter"]="@filtering"
FILE_TAG_MAP["sort"]="@sorting"
FILE_TAG_MAP["responsive"]="@responsive"
FILE_TAG_MAP["mobile"]="@responsive"
FILE_TAG_MAP["pwa"]="@pwa"
FILE_TAG_MAP["service-worker"]="@pwa"
FILE_TAG_MAP["performance"]="@performance"
FILE_TAG_MAP["accessibility"]="@accessibility"

# Get list of changed files
CHANGED_FILES=$(git diff --cached --name-only)

echo "ğŸ“‹ Changed files detected:"
echo "$CHANGED_FILES"

# Initialize test tags to run
TAGS_TO_RUN="$SMOKE_TESTS"
ADDITIONAL_TAGS=""

# Analyze changed files and determine additional test tags
for file in $CHANGED_FILES; do
    filename=$(basename "$file" | tr '[:upper:]' '[:lower:]')
    
    # Check each pattern in our mapping
    for pattern in "${!FILE_TAG_MAP[@]}"; do
        if [[ "$filename" == *"$pattern"* ]]; then
            tag="${FILE_TAG_MAP[$pattern]}"
            if [[ ! "$ADDITIONAL_TAGS" == *"$tag"* ]]; then
                ADDITIONAL_TAGS="$ADDITIONAL_TAGS $tag"
                echo "ğŸ¯ File '$file' matches pattern '$pattern' -> Adding tag: $tag"
            fi
        fi
    done
done

# Combine smoke tests with additional tags
if [ ! -z "$ADDITIONAL_TAGS" ]; then
    TAGS_TO_RUN="$SMOKE_TESTS|${ADDITIONAL_TAGS// /|}"
else
    TAGS_TO_RUN="$SMOKE_TESTS"
fi

echo ""
echo "ğŸš€ Test Execution Plan:"
echo "   Smoke Tests: Always run ($SMOKE_TESTS)"
if [ ! -z "$ADDITIONAL_TAGS" ]; then
    echo "   Additional Tags: $ADDITIONAL_TAGS"
fi
echo "   Final Tag Pattern: $TAGS_TO_RUN"
echo ""

# Create Jenkins trigger file with test parameters
cat > .jenkins-trigger <<EOF
# Jenkins CI/CD Trigger Configuration
# Generated by pre-commit hook on $(date)

TEST_SUITE=smart-execution
TAGS_TO_RUN=$TAGS_TO_RUN
CHANGED_FILES<<DELIMITER
$CHANGED_FILES
DELIMITER
GENERATE_REPORTS=true
TRIGGER_TYPE=pre-commit
COMMIT_HASH=$(git rev-parse HEAD)
AUTHOR=$(git config user.name)
BRANCH=$(git rev-parse --abbrev-ref HEAD)
TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
EOF

echo "âœ… Jenkins trigger configuration created (.jenkins-trigger)"

# Optional: Run quick smoke tests locally (uncomment if desired)
# echo "ğŸ§ª Running smoke tests locally..."
# npx playwright test --grep "@smoke" --project=chromium --reporter=line

echo ""
echo "ğŸ‰ Pre-commit analysis complete!"
echo "   Jenkins will execute: $TAGS_TO_RUN"
echo "   Full regression scheduled for off-hours"
echo ""

exit 0